# DDPM ì˜ë£Œ ì˜ìƒ ë””ë…¸ì´ì§• ê¸°ìˆ ë¬¸ì„œ

## ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [ë¬¸ì œ ì •ì˜](#ë¬¸ì œ-ì •ì˜)
3. [ë…¸ì´ì¦ˆ ìœ í˜• ë¶„ì„](#ë…¸ì´ì¦ˆ-ìœ í˜•-ë¶„ì„)
4. [ë””ë…¸ì´ì§• ê¸°ë²•](#ë””ë…¸ì´ì§•-ê¸°ë²•)
   - [4.1 Z-ìŠ¬ë¼ì´ìŠ¤ ê°•ë„ ë³´ì •](#41-z-ìŠ¬ë¼ì´ìŠ¤-ê°•ë„-ë³´ì •)
   - [4.2 Mean Intensity Gradient ê¸°ë°˜ Z-ì˜ì—­ ë…¸ì´ì¦ˆ ì œê±°](#42-mean-intensity-gradient-ê¸°ë°˜-z-ì˜ì—­-ë…¸ì´ì¦ˆ-ì œê±°)
   - [4.3 ìµœì¢… í‰í™œí™”](#43-ìµœì¢…-í‰í™œí™”)
   - [4.4 ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±°](#44-ìˆ˜í‰-ìŠ¤íŠ¸ë¼ì´í”„-ì œê±°)
   - [4.5 ë‡Œ ê²½ê³„ ë§ˆìŠ¤í‚¹ (Boundary Masking)](#45-ë‡Œ-ê²½ê³„-ë§ˆìŠ¤í‚¹-boundary-masking)
5. [ì„±ëŠ¥ í‰ê°€](#ì„±ëŠ¥-í‰ê°€)
6. [ì‚¬ìš© ë°©ë²•](#ì‚¬ìš©-ë°©ë²•)
7. [íŒŒë¼ë¯¸í„° ì„¤ì • ê°€ì´ë“œ](#íŒŒë¼ë¯¸í„°-ì„¤ì •-ê°€ì´ë“œ)

---

## ê°œìš”

ë³¸ ë¬¸ì„œëŠ” DDPM(Denoising Diffusion Probabilistic Models)ì„ ì‚¬ìš©í•œ ì˜ë£Œ ì˜ìƒ ìƒì„± ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ì•„í‹°íŒ©íŠ¸ë¥¼ ì œê±°í•˜ê¸° ìœ„í•œ í†µí•© ë””ë…¸ì´ì§• íŒŒì´í”„ë¼ì¸ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

### ê°œë°œ ë°°ê²½
- DDPM ê¸°ë°˜ ì´ˆí•´ìƒë„(Super-Resolution) ì˜ë£Œ ì˜ìƒ ìƒì„± ì‹œ íŠ¹ì • ì•„í‹°íŒ©íŠ¸ ë°œìƒ
- ë‡Œ MRI ì˜ìƒì—ì„œ ê´€ì°°ë˜ëŠ” ì£¼ìš” ë…¸ì´ì¦ˆ íŒ¨í„´ ë° ë°°ê²½ ì•„í‹°íŒ©íŠ¸
- ì§„ë‹¨ í’ˆì§ˆ í™•ë³´ë¥¼ ìœ„í•œ ìë™í™”ëœ ë…¸ì´ì¦ˆ ì œê±° í•„ìš”ì„±
- ë‹¤ì–‘í•œ ë°ì´í„°ì…‹ì— ì¼ë°˜í™” ê°€ëŠ¥í•œ robustí•œ ë°©ë²• í•„ìš”
- ë…¸ì´ì§€í•œ ë°°ê²½ì„ ê°€ì§„ ë°ì´í„°ì—ì„œë„ ê´€ì‹¬ ì˜ì—­(ROI) ì¶”ì¶œ ê°€ëŠ¥í•œ ë°©ë²• í•„ìš”

### ê¸°ìˆ  ìŠ¤íƒ
- **ì–¸ì–´**: Python 3.x
- **ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬**:
  - `nibabel`: NIfTI ì˜ë£Œ ì˜ìƒ í¬ë§· ì²˜ë¦¬
  - `numpy`: ë‹¤ì°¨ì› ë°°ì—´ ì—°ì‚°
  - `scipy`: ì‹ í˜¸ ì²˜ë¦¬ ë° í•„í„°ë§
  - `cv2` (OpenCV): ì˜ìƒ ì²˜ë¦¬ ë° edge detection
  - `skimage` (scikit-image): Morphological operations
  - `matplotlib`: ì‹œê°í™”

### íŒŒì´í”„ë¼ì¸ êµ¬ì¡° (5ë‹¨ê³„)
```
1. Z-ìŠ¬ë¼ì´ìŠ¤ ê°•ë„ ë³´ì • (Savitzky-Golay)
   â†“
2. Mean Intensity Gradient ê¸°ë°˜ Z-ì˜ì—­ ì œê±° (Gradient Detection)
   â†“
3. ìµœì¢… í‰í™œí™” (Gaussian Filter, Ïƒ=0.2)
   â†“
4. ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±° (FFT + Fade Transition)
   â†“
5. ë‡Œ ê²½ê³„ ë§ˆìŠ¤í‚¹ (Edge-based ROI Extraction)
```

**ì²˜ë¦¬ ìˆœì„œì˜ ì¤‘ìš”ì„±**:
- Z-ì˜ì—­ ë…¸ì´ì¦ˆë¥¼ ë¨¼ì € ì œê±°í•œ í›„ boundary maskingì„ ìˆ˜í–‰
- ë…¸ì´ì¦ˆ ì˜ì—­ì´ contour ê²€ì¶œì— í¬í•¨ë˜ëŠ” ê²ƒì„ ë°©ì§€
- ìŠ¤íŠ¸ë¼ì´í”„ ì œê±°ëŠ” í‰í™œí™” í›„ ì ìš©í•˜ì—¬ ë‹¤ë¥¸ ë…¸ì´ì¦ˆì™€ ë¶„ë¦¬

---

## ë¬¸ì œ ì •ì˜

### ì…ë ¥ ë°ì´í„°
- **í¬ë§·**: NIfTI (.nii.gz)
- **í˜•ìƒ**: 192 Ã— 192 Ã— 192 ë³µì…€ (3D ë³¼ë¥¨)
- **ë°ì´í„° íƒ€ì…**: float32
- **ê°•ë„ ë²”ìœ„**: ì •ê·œí™”ëœ ê°’ (ì¼ë°˜ì ìœ¼ë¡œ -0.2 ~ 1.2)

### ë°œìƒí•˜ëŠ” ë…¸ì´ì¦ˆ ìœ í˜•

#### 1. Z-ë°©í–¥ ìƒë‹¨ ë…¸ì´ì¦ˆ ì¡´ (DDPM ì•„í‹°íŒ©íŠ¸)
- **ìœ„ì¹˜**: Z-ì¶• ìƒìœ„ ì˜ì—­ (ì•½ 70-95% êµ¬ê°„)
- **íŠ¹ì§•**:
  - DDPM ëª¨ë¸ì˜ êµ¬ì¡°ì  í•œê³„ë¡œ ì¸í•œ ë°œìƒ
  - ë‡Œ ì˜ì—­ì´ ê³ ìŠ¤íŠ¸ì²˜ëŸ¼ ë²ˆì§€ëŠ” í˜„ìƒ
  - Mean intensityê°€ ê¸‰ê²©íˆ ì¦ê°€í•˜ëŠ” ì§€ì ë¶€í„° ì‹œì‘
  - Salt-and-pepper ë…¸ì´ì¦ˆ íŒ¨í„´
  - ì‹¤ì œ í•´ë¶€í•™ì  êµ¬ì¡°ê°€ ì•„ë‹Œ ìƒì„± ì•„í‹°íŒ©íŠ¸
- **ì˜í–¥**: ì§„ë‹¨ ì˜¤ë¥˜ ê°€ëŠ¥ì„±, ì‹œê°ì  í’ˆì§ˆ ì €í•˜

#### 2. ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì•„í‹°íŒ©íŠ¸
- **ìœ„ì¹˜**: ì „ì²´ ë³¼ë¥¨ì— ê±¸ì³ ë°œìƒ
- **íŠ¹ì§•**:
  - Sagittal view (ì‹œìƒë©´)ì—ì„œ ê°€ë¡œ ì¤„ë¬´ëŠ¬ë¡œ ê´€ì°°ë¨
  - Z-ì¶• ë°©í–¥ìœ¼ë¡œ ì£¼ê¸°ì ì¸ ê°•ë„ ë³€í™”
  - FFT ë¶„ì„ ì‹œ ê³ ì£¼íŒŒ ì„±ë¶„ìœ¼ë¡œ ë‚˜íƒ€ë‚¨
  - 96th-98th ë°±ë¶„ìœ„ìˆ˜ ì´ìƒì˜ ì£¼íŒŒìˆ˜ ì„±ë¶„
- **ì˜í–¥**: ì¡°ì§ ê²½ê³„ ëª¨í˜¸í™”, ë¯¸ì„¸ êµ¬ì¡° ê°€ì‹œì„± ì €í•˜

#### 3. Z-ìŠ¬ë¼ì´ìŠ¤ë³„ ê°•ë„ ì´ìƒê°’
- **ìœ„ì¹˜**: ì‚°ë°œì ìœ¼ë¡œ ë¶„í¬
- **íŠ¹ì§•**:
  - íŠ¹ì • ìŠ¬ë¼ì´ìŠ¤ì—ì„œ ê°‘ì‘ìŠ¤ëŸ¬ìš´ ê°•ë„ ì í”„
  - Savitzky-Golay í‰í™œí™” ê³¡ì„ ì—ì„œ ë²—ì–´ë‚¨
  - ì¼ë°˜ì ìœ¼ë¡œ 10-30ê°œ ìŠ¬ë¼ì´ìŠ¤ ì˜í–¥
- **ì˜í–¥**: Z-ì¶• í”„ë¡œíŒŒì¼ì˜ ë¶ˆì—°ì†ì„±

#### 4. ë°°ê²½ ë…¸ì´ì¦ˆ ë° ì•„í‹°íŒ©íŠ¸
- **ìœ„ì¹˜**: ë‡Œ ì˜ì—­ ì™¸ë¶€ ë°°ê²½
- **íŠ¹ì§•**:
  - ë…¸ì´ì§€í•œ ë°ì´í„°ì—ì„œ ë°°ê²½ intensityê°€ ë‡Œ ì¡°ì§ê³¼ ìœ ì‚¬í•œ ê°’ì„ ê°€ì§
  - Edge detectionì´ ì–´ë ¤ìš´ low-contrast ì˜ì—­
  - ì¼ë¶€ ë°ì´í„°ì…‹(ì˜ˆ: gneo_002)ì—ì„œ ì‹¬ê°í•˜ê²Œ ë‚˜íƒ€ë‚¨
  - ë°°ê²½ê³¼ ì „ê²½ì˜ ëª…í™•í•œ ë¶„ë¦¬ê°€ ì–´ë ¤ì›€
- **ì˜í–¥**:
  - ë¶„ì„ ì‹œ ë°°ê²½ ì˜ì—­ì´ ê´€ì‹¬ ì˜ì—­ìœ¼ë¡œ ì˜¤ì¸ë  ìˆ˜ ìˆìŒ
  - í†µê³„ ë¶„ì„ ì‹œ ë°°ê²½ ë…¸ì´ì¦ˆê°€ í¬í•¨ë˜ì–´ ê²°ê³¼ ì™œê³¡
  - ì‹œê°í™” í’ˆì§ˆ ì €í•˜

---

## ë…¸ì´ì¦ˆ ìœ í˜• ë¶„ì„

### 1. Z-ì¶• ê°•ë„ í”„ë¡œíŒŒì¼ ë¶„ì„

```
ë¶„ì„ ë°©ë²•:
- ê° Z-ìŠ¬ë¼ì´ìŠ¤ì˜ í‰ê·  ê°•ë„ ê³„ì‚°
- Z-ì¶•ì„ ë”°ë¼ ê°•ë„ ë³€í™” ì¶”ì 
- Gradient (1ì°¨ ë¯¸ë¶„) ë¶„ì„ìœ¼ë¡œ ê¸‰ì¦ ì§€ì  ê°ì§€
```

**ì£¼ìš” ë°œê²¬ì‚¬í•­**:
- Mean intensityê°€ ê¸‰ê²©íˆ ì¦ê°€í•˜ëŠ” ì§€ì  = ë…¸ì´ì¦ˆ ì˜ì—­ ì‹œì‘
- Gradient > mean + 2*std ì§€ì ì—ì„œ ë…¸ì´ì¦ˆ ê²½ê³„ ìë™ ê°ì§€
- ì¼ë°˜ì ìœ¼ë¡œ Z=170-180 êµ¬ê°„ì—ì„œ ê²½ê³„ ë°œê²¬ (ë°ì´í„°ì— ë”°ë¼ ë‹¤ë¦„)
- ë‘ê°œê³¨ ëë¶€ë¶„ì—ì„œ ì¢Œ-ìš°ë¡œ ê°ˆìˆ˜ë¡ ë…¸ì´ì¦ˆ ì¦ê°€í•˜ëŠ” ë°©ì‚¬í˜• íŒ¨í„´

### 2. ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì£¼íŒŒìˆ˜ ë¶„ì„

**FFT ë¶„ì„ ê²°ê³¼**:
- Z-ì¶• ë°©í–¥ 1D FFTì—ì„œ ê³ ì£¼íŒŒ ì„±ë¶„ì´ ìŠ¤íŠ¸ë¼ì´í”„ì— ëŒ€ì‘
- 96th-98th ë°±ë¶„ìœ„ìˆ˜ ì´ìƒì˜ ê³ ì£¼íŒŒê°€ ì£¼ìš” ì›ì¸
- ì €ì£¼íŒŒ ì„±ë¶„ì€ ì‹¤ì œ í•´ë¶€í•™ì  êµ¬ì¡°ë¥¼ ë‚˜íƒ€ëƒ„ (ë³´ì¡´ í•„ìš”)
- ì¤‘ì‹¬ ì£¼íŒŒìˆ˜ë¡œë¶€í„° ê±°ë¦¬ì— ë”°ë¥¸ fade transition í•„ìš”

### 3. ë°ì´í„°ì…‹ ê°„ ì°¨ì´

**ì¼ë°˜í™” ë¬¸ì œ**:
- ê° ë°ì´í„°ì…‹ë§ˆë‹¤ ë…¸ì´ì¦ˆ ê²½ê³„ ìœ„ì¹˜ê°€ ë‹¤ë¦„
- Slice-wise noise analysisëŠ” íŠ¹ì • ë°ì´í„°ì—ë§Œ ìµœì í™”ë¨
- **í•´ê²°ì±…**: Mean intensity gradient ê¸°ë°˜ ìë™ ê°ì§€

---

## ë””ë…¸ì´ì§• ê¸°ë²•

### 4.1 Z-ìŠ¬ë¼ì´ìŠ¤ ê°•ë„ ë³´ì •

#### ëª©ì 
Z-ì¶•ì„ ë”°ë¼ ë°œìƒí•˜ëŠ” ìŠ¬ë¼ì´ìŠ¤ë³„ ê°•ë„ ì´ìƒê°’ì„ ê°ì§€í•˜ê³  ë³´ì •í•˜ì—¬ ì¼ê´€ëœ ê°•ë„ ë¶„í¬ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

#### ì•Œê³ ë¦¬ì¦˜

```
1. ê° Z-ìŠ¬ë¼ì´ìŠ¤ì˜ í‰ê·  ê°•ë„ ê³„ì‚°
   z_means[z] = mean(data[:, :, z])

2. Savitzky-Golay í•„í„° ì ìš© â†’ ë¶€ë“œëŸ¬ìš´ ì°¸ì¡° ê³¡ì„  ìƒì„±
   - Window length: 13 (ê¸°ë³¸ê°’)
   - Polynomial order: 2
   - ì´ìœ : êµ­ì†Œì  ë³€í™”ëŠ” í¬ì°©í•˜ë˜ ë…¸ì´ì¦ˆëŠ” ì œê±°

3. í¸ì°¨ ê³„ì‚°
   deviations[z] = z_means[z] - z_means_smoothed[z]

4. ì´ìƒ ìŠ¬ë¼ì´ìŠ¤ ê°ì§€
   anomalous if |deviation[z]| > threshold Ã— std(deviations)
   - ê¸°ë³¸ threshold: 1.0 (í‘œì¤€í¸ì°¨ì˜ 1ë°°)

5. ì´ìƒ ìŠ¬ë¼ì´ìŠ¤ ë³´ì • (clipping ì ìš©)
   correction_factor = z_means_smoothed[z] / z_means[z]
   correction_factor = clip(correction_factor, 0.7, 1.5)
   data[:, :, z] *= correction_factor
```

#### ìˆ˜í•™ì  ê·¼ê±°

**Savitzky-Golay í•„í„°**:
- ì´ë™ ìœˆë„ìš° ë‚´ì—ì„œ ë‹¤í•­ì‹ í”¼íŒ…ì„ ìˆ˜í–‰í•˜ëŠ” í‰í™œí™” ê¸°ë²•
- ì¥ì : ì—£ì§€ì™€ í”¼í¬ë¥¼ ë³´ì¡´í•˜ë©´ì„œ ë…¸ì´ì¦ˆ ì œê±°
- ìˆ˜ì‹: ê° ì ì—ì„œ ì£¼ë³€ ì ë“¤ì— ëŒ€í•´ 2ì°¨ ë‹¤í•­ì‹ íšŒê·€ ìˆ˜í–‰

**ë³´ì • ê³„ìˆ˜ Clipping**:
```python
correction_factor = expected / observed
correction_factor = clip(correction_factor, 0.7, 1.5)  # ê³¼ë„í•œ ë³´ì • ë°©ì§€
```
- 0.7~1.5 ë²”ìœ„ë¡œ ì œí•œí•˜ì—¬ ê·¹ë‹¨ì ì¸ ë³´ì • ë°©ì§€
- ë°ì´í„° ë¬´ê²°ì„± ë³´ì¡´

#### íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ë²”ìœ„ | íš¨ê³¼ |
|---------|--------|------|------|
| detection_threshold | 1.0 | 0.5~2.0 | ë†’ì„ìˆ˜ë¡ ë³´ìˆ˜ì  ê°ì§€ |
| smoothing_window | 13 | 5~21 (í™€ìˆ˜) | í´ìˆ˜ë¡ ì „ì—­ì  ì¶”ì„¸ í¬ì°© |

#### íš¨ê³¼
- **ì œê±° ëŒ€ìƒ**: íŠ¹ì • ìŠ¬ë¼ì´ìŠ¤ì˜ ê°‘ì‘ìŠ¤ëŸ¬ìš´ ê°•ë„ ë³€í™”
- **ë³´ì¡´ ëŒ€ìƒ**: ì •ìƒì ì¸ í•´ë¶€í•™ì  ë³€í™” (ì˜ˆ: íšŒë°±ì§ˆ â†’ ë°±ì§ˆ ì „í™˜)
- **ê²°ê³¼**: 10-30ê°œì˜ ì´ìƒ ìŠ¬ë¼ì´ìŠ¤ ë³´ì •

---

### 4.4 ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±°

#### ëª©ì 
Z-ì¶• ë°©í–¥ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ì£¼ê¸°ì ì¸ ê°•ë„ ë³€í™” (ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„)ë¥¼ ì£¼íŒŒìˆ˜ ë„ë©”ì¸ì—ì„œ ì œê±°í•˜ë©´ì„œ ì„¸ë¡œ ì•¨ë¦¬ì–´ì‹±ì„ ë°©ì§€í•©ë‹ˆë‹¤.

#### ì•Œê³ ë¦¬ì¦˜: FFT ê¸°ë°˜ í•„í„°ë§ + Fade Transition

```
1. ê° (x, y) ìœ„ì¹˜ì—ì„œ Z-ì¶• 1D ì‹ í˜¸ ì¶”ì¶œ
   signal = data[x, y, :]

2. FFT ë³€í™˜ â†’ ì£¼íŒŒìˆ˜ ë„ë©”ì¸
   fft_signal = FFT(signal)
   fft_shifted = fftshift(fft_signal)  # ì¤‘ì‹¬ì— ì €ì£¼íŒŒ ë°°ì¹˜

3. ì£¼íŒŒìˆ˜ ì„±ë¶„ ë¶„ì„
   magnitude = abs(fft_shifted)

4. ì €ì£¼íŒŒ ë³´ì¡´ ì˜ì—­ ì„¤ì • (ì•¨ë¦¬ì–´ì‹± ë°©ì§€)
   center = len(fft_shifted) // 2
   preserve_radius = max(5, len(fft_shifted) // 12)  # ê¸°ë³¸ ëª¨ë“œ
   # ë˜ëŠ” len(fft_shifted) // 15  # ê³µê²©ì  ëª¨ë“œ

5. ê³ ì£¼íŒŒ ì–µì œ ë§ˆìŠ¤í¬ ìƒì„±
   threshold = percentile(magnitude, 96)  # ê¸°ë³¸ ëª¨ë“œ
   # ë˜ëŠ” percentile(magnitude, 94)  # ê³µê²©ì  ëª¨ë“œ

6. Fade Transition ì ìš© (í•µì‹¬ ê°œì„ !)
   for idx in range(len(fft_shifted)):
       distance = abs(idx - center)
       if distance > preserve_radius and magnitude[idx] > threshold:
           suppression = filter_strength
           if distance < preserve_radius * 1.5:
               # ì „í™˜ ì˜ì—­: ë¶€ë“œëŸ½ê²Œ ê°ì‡ 
               fade = (distance - preserve_radius) / (preserve_radius * 0.5)
               suppression = filter_strength * fade
           filter_mask[idx] = 1.0 - suppression

7. í•„í„° ì ìš©
   fft_filtered = fft_shifted * filter_mask

8. ì—­ë³€í™˜ â†’ ê³µê°„ ë„ë©”ì¸
   fft_back = ifftshift(fft_filtered)
   filtered_signal = IFFT(fft_back).real
   data[x, y, :] = filtered_signal
```

#### ì£¼ìš” ê°œì„ ì‚¬í•­ (ì•¨ë¦¬ì–´ì‹± ë°©ì§€)

**1. ì €ì£¼íŒŒ ë³´ì¡´ ì˜ì—­ í™•ëŒ€**
```python
ê¸°ì¡´: len // 15  (6.7% ë³´ì¡´)
ê°œì„ : len // 12  (8.3% ë³´ì¡´, 25% ì¦ê°€)
```
- í•´ë¶€í•™ì  êµ¬ì¡°ë¥¼ ë” ì˜ ë³´ì¡´
- ì„¸ë¡œ ë°©í–¥ ì•„í‹°íŒ©íŠ¸ ë°©ì§€

**2. Threshold ê°ì†Œ (ë” ê³µê²©ì )**
```python
ê¸°ì¡´: 98th percentile
ê°œì„ : 96th percentile
```
- ë” ë§ì€ ê³ ì£¼íŒŒ ì„±ë¶„ íƒ€ê²ŸíŒ…
- ìŠ¤íŠ¸ë¼ì´í”„ë¥¼ ë” ê°•í•˜ê²Œ ì œê±°

**3. Fade Transition ì¶”ê°€**
```python
# ì €ì£¼íŒŒ ì¸ê·¼ ì˜ì—­ì—ì„œ ë¶€ë“œëŸ¬ìš´ ì „í™˜
if distance < preserve_radius * 1.5:
    fade = (distance - preserve_radius) / (preserve_radius * 0.5)
    suppression = filter_strength * fade
```
- ê¸‰ê²©í•œ í•„í„°ë§ ë³€í™” ë°©ì§€
- ì•¨ë¦¬ì–´ì‹± ì™„ì „ ë°©ì§€

#### ì£¼íŒŒìˆ˜ ë„ë©”ì¸ í•„í„°ë§ ì›ë¦¬

**FFT (Fast Fourier Transform)**:
- ê³µê°„ ë„ë©”ì¸ì˜ ì‹ í˜¸ë¥¼ ì£¼íŒŒìˆ˜ ì„±ë¶„ìœ¼ë¡œ ë¶„í•´
- ìˆ˜ì‹: `F(k) = Î£ f(x) Ã— e^(-2Ï€ikx/N)`
- ê²°ê³¼: ê° ì£¼íŒŒìˆ˜ ì„±ë¶„ì˜ ê°•ë„ì™€ ìœ„ìƒ ì •ë³´

**ìŠ¤íŠ¸ë¼ì´í”„ = ê³ ì£¼íŒŒ ì„±ë¶„**:
```
ì˜ˆì‹œ:
- ì €ì£¼íŒŒ: ì „ì²´ì ì¸ ë°ê¸° ë³€í™” (ë‡Œ ì¡°ì§ì˜ ìì—°ìŠ¤ëŸ¬ìš´ ë³€í™”)
- ê³ ì£¼íŒŒ: ê¸‰ê²©í•œ ë³€í™” (ìŠ¤íŠ¸ë¼ì´í”„, ë…¸ì´ì¦ˆ)

Z-ì¶• ì‹ í˜¸:
[0.5, 0.52, 0.48, 0.51, 0.49, ...]  â† ì €ì£¼íŒŒ (ë³´ì¡´)
[0.5, 0.9, 0.1, 0.8, 0.2, ...]      â† ê³ ì£¼íŒŒ (ì–µì œ)
```

#### íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ë²”ìœ„ | íš¨ê³¼ |
|---------|--------|------|------|
| filter_strength | 0.6 | 0.3~0.8 | ë†’ì„ìˆ˜ë¡ ê°•í•˜ê²Œ ì œê±° |
| iterations | 1 | 1~2 | ë§ì„ìˆ˜ë¡ ë°˜ë³µ ì œê±° |
| aggressive | False | True/False | Trueì‹œ ë” ê³µê²©ì  |

**Aggressive ëª¨ë“œ**:
```python
aggressive=True:
  preserve_radius = len // 15  (ë” ì¢ìŒ)
  threshold = 94th percentile  (ë” ë‚®ìŒ)
  â†’ ë” ê°•ë ¥í•œ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±°
```

#### íš¨ê³¼ ë¹„êµ

| ëª¨ë“œ | Threshold | Preserve Radius | ì—£ì§€ ë³´ì¡´ | ì•¨ë¦¬ì–´ì‹± |
|------|-----------|----------------|----------|---------|
| ê¸°ë³¸ | 96th | len//12 | 99.99% | ì—†ìŒ |
| ê³µê²©ì  | 94th | len//15 | 99.97% | ì—†ìŒ |

---

### 4.2 Mean Intensity Gradient ê¸°ë°˜ Z-ì˜ì—­ ë…¸ì´ì¦ˆ ì œê±°

#### ëª©ì 
Mean intensityê°€ ê¸‰ê²©íˆ ì¦ê°€í•˜ëŠ” ì§€ì ì„ ìë™ ê°ì§€í•˜ì—¬ ë…¸ì´ì¦ˆ ì˜ì—­ì„ ì œê±°í•©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ë‹¤ì–‘í•œ ë°ì´í„°ì…‹ì— ì¼ë°˜í™” ê°€ëŠ¥í•©ë‹ˆë‹¤.

#### ê¸°ì¡´ ë°©ë²•ì˜ í•œê³„

**Slice-wise Noise Analysis (Adaptive ë°©ë²•)**:
```
ë¬¸ì œì :
- ê° ìŠ¬ë¼ì´ìŠ¤ì˜ 6ê°€ì§€ ë©”íŠ¸ë¦­ ë¶„ì„ (ë³µì¡í•¨)
- íŠ¹ì • ë°ì´í„°ì—ë§Œ ìµœì í™”ë¨
- ë‹¤ë¥¸ ë°ì´í„°ì—ì„œ Z=150 vs Z=175 ë“± í° ì°¨ì´ ë°œìƒ
- Salt-and-pepper ë…¸ì´ì¦ˆ íŠ¹ì„±ì— ì˜ì¡´
```

**Mean Intensity Gradient (ìƒˆë¡œìš´ ë°©ë²•)**:
```
ì¥ì :
- ë‹¨ìˆœí•˜ê³  ì§ê´€ì 
- Mean intensity ê¸‰ì¦ ì§€ì  ê°ì§€
- ë°ì´í„°ì…‹ì— ë¬´ê´€í•˜ê²Œ ì¼ë°˜í™” ê°€ëŠ¥
- Robustí•˜ê³  ì‹ ë¢°ì„± ë†’ìŒ
```

#### ì•Œê³ ë¦¬ì¦˜

```
1. ë¶„ì„ ì‹œì‘ì  ì„¤ì •
   search_start = int(z_dim Ã— 0.70)  # 70% ì§€ì ë¶€í„°

2. Z-ì¶• mean intensity ê³„ì‚°
   z_means[z] = mean(data[:, :, z]) for z in range(z_dim)

3. Savitzky-Golay í•„í„°ë¡œ í‰í™œí™”
   z_means_smooth = savgol_filter(z_means, window_length=11, polyorder=2)

4. Gradient (1ì°¨ ë¯¸ë¶„) ê³„ì‚°
   gradient[z] = d(z_means_smooth) / dz
   # intensity ì¦ê°€ìœ¨ ì¸¡ì •

5. Gradient í†µê³„ ê³„ì‚° (ê²€ìƒ‰ ì˜ì—­ì—ì„œë§Œ)
   grad_mean = mean(gradient[search_start:])
   grad_std = std(gradient[search_start:])

6. ê¸‰ê²©í•œ ì¦ê°€ ê°ì§€
   threshold_value = grad_mean + gradient_threshold Ã— grad_std

   for z in range(search_start, z_dim):
       if gradient[z] > threshold_value:
           detected_boundary = z
           break

7. ëŒ€ì•ˆ ê°ì§€ (gradient ë°©ë²• ì‹¤íŒ¨ ì‹œ)
   intensity_threshold = percentile(z_means_smooth, 90)

   for z in range(search_start, z_dim):
       if z_means_smooth[z] > intensity_threshold:
           detected_boundary = z
           break

8. Smooth Transition ì ìš© (8-slice fade-out)
   transition_length = 8
   transition_start = detected_boundary - transition_length

   for i, z in enumerate(range(transition_start, detected_boundary)):
       t = (i + 1) / (transition_length + 1)
       alpha = 1.0 - (3Ã—tÂ² - 2Ã—tÂ³)  # Smooth step function
       data[:, :, z] *= alpha

9. ë…¸ì´ì¦ˆ ì˜ì—­ ì™„ì „ ì œê±°
   data[:, :, detected_boundary:] = 0.0
```

#### ìˆ˜í•™ì  ê·¼ê±°

**Gradient (1ì°¨ ë¯¸ë¶„)**:
```
gradient[z] = (z_means[z+1] - z_means[z-1]) / 2

ì˜ë¯¸:
- ì–‘ìˆ˜: intensity ì¦ê°€ ì¤‘
- ìŒìˆ˜: intensity ê°ì†Œ ì¤‘
- í° ì–‘ìˆ˜ê°’: ê¸‰ê²©í•œ ì¦ê°€ (ë…¸ì´ì¦ˆ ì˜ì—­ ì‹œì‘!)
```

**Smooth Step Function**:
```
alpha(t) = 1.0 - (3tÂ² - 2tÂ³)

íŠ¹ì„±:
- t=0: alpha=1.0 (ì›ë³¸ ìœ ì§€)
- t=0.5: alpha=0.5 (50% ê°ì‡ )
- t=1.0: alpha=0.0 (ì™„ì „ ì œê±°)
- ë¶€ë“œëŸ¬ìš´ S-ì»¤ë¸Œ í˜•íƒœ
```

#### ì˜ˆì‹œ

```
ë°ì´í„°: gneo_sample_sr_189.nii.gz

ê²€ìƒ‰ ì˜ì—­: Z=134~191
Gradient í‰ê· : 0.000543
Gradient í‘œì¤€í¸ì°¨: 0.008030
Threshold: 0.000543 + 2.0 Ã— 0.008030 = 0.016603

Z=175ì—ì„œ gradient=0.018987 > 0.016603
â†’ ê¸‰ê²©í•œ intensity ì¦ê°€ ê°ì§€!

Transition: Z=167-174 (8 slices, fade-out)
Complete removal: Z=175-191 (17 slices)
```

#### íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ë²”ìœ„ | íš¨ê³¼ |
|---------|--------|------|------|
| min_z_start | 0.70 | 0.60~0.80 | ê²€ìƒ‰ ì‹œì‘ ìœ„ì¹˜ |
| gradient_threshold | 2.0 | 1.0~3.0 | ë†’ì„ìˆ˜ë¡ ë³´ìˆ˜ì  |
| transition_length | 8 | 4~12 | Fade-out êµ¬ê°„ í¬ê¸° |

#### ë°©ë²• ë¹„êµ

| ë°©ë²• | ê²½ê³„ ê°ì§€ | ì¼ë°˜í™” | ê³„ì‚° ë³µì¡ë„ | Robustì„± |
|------|----------|--------|-----------|---------|
| **Gradient (ê¶Œì¥)** | **Z=175** | **ë†’ìŒ** | **ë‚®ìŒ** | **ë†’ìŒ** |
| Adaptive | Z=179 | ë³´í†µ | ë†’ìŒ | ì¤‘ê°„ |
| Conservative | Z=161 | ë‚®ìŒ | ì¤‘ê°„ | ë‚®ìŒ |

---

### 4.3 ìµœì¢… í‰í™œí™”

#### ëª©ì 
ë””ë…¸ì´ì§• ê³¼ì •ì—ì„œ ìƒê¸´ ë¯¸ì„¸í•œ ì•„í‹°íŒ©íŠ¸ë¥¼ ì œê±°í•˜ê³  ë¶€ë“œëŸ¬ìš´ ê²°ê³¼ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

#### ì•Œê³ ë¦¬ì¦˜

```python
for z in range(z_dim):
    data[:, :, z] = gaussian_filter(data[:, :, z], sigma=0.2)
```

**Gaussian í•„í„°**:
- 2D Gaussian kernel ì ìš©
- sigma=0.2: ë§¤ìš° ë¶€ë“œëŸ¬ìš´ í‰í™œí™”
- ê° ìŠ¬ë¼ì´ìŠ¤ì— ë…ë¦½ì ìœ¼ë¡œ ì ìš©

#### íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ë²”ìœ„ | íš¨ê³¼ |
|---------|--------|------|------|
| sigma | 0.2 | 0.1~0.5 | ë†’ì„ìˆ˜ë¡ ê°•í•œ í‰í™œí™” |

#### íš¨ê³¼
- ë¯¸ì„¸í•œ FFT ì•„í‹°íŒ©íŠ¸ ì œê±°
- ë¶€ë“œëŸ¬ìš´ ì „í™˜ ë³´ì¥
- ì—£ì§€ ë³´ì¡´ìœ¨ ìœ ì§€ (99.99%)

---

### 4.5 ë‡Œ ê²½ê³„ ë§ˆìŠ¤í‚¹ (Boundary Masking)

#### ëª©ì 
ë…¸ì´ì§€í•œ ë°°ê²½ì„ ê°€ì§„ ì˜ë£Œ ì˜ìƒì—ì„œ ê´€ì‹¬ ì˜ì—­(ë‡Œ, ë‘ê°œê³¨ ë“±)ë§Œ ì¶”ì¶œí•˜ê³  ë°°ê²½ ì•„í‹°íŒ©íŠ¸ë¥¼ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤. íŠ¹íˆ ë°°ê²½ intensityê°€ ë‡Œ ì¡°ì§ê³¼ ìœ ì‚¬í•œ ê°’ì„ ê°€ì§„ ë°ì´í„°ì…‹ì—ì„œë„ robustí•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤.

#### ë¬¸ì œì 
- ì¼ë¶€ ë°ì´í„°ì…‹(ì˜ˆ: gneo_002)ì—ì„œ ë°°ê²½ ë…¸ì´ì¦ˆê°€ ë‡Œ ì˜ì—­ê³¼ ìœ ì‚¬í•œ intensityë¥¼ ê°€ì§
- ë‹¨ìˆœ threshold ë°©ì‹ìœ¼ë¡œëŠ” ë°°ê²½ê³¼ ì „ê²½ ë¶„ë¦¬ê°€ ì–´ë ¤ì›€
- í†µê³„ ë¶„ì„ ì‹œ ë°°ê²½ ë…¸ì´ì¦ˆê°€ í¬í•¨ë˜ì–´ ê²°ê³¼ ì™œê³¡

#### ì•Œê³ ë¦¬ì¦˜: Edge-based ROI Extraction (V1)

**ì „ì²´ í”„ë¡œì„¸ìŠ¤**:
```
ì…ë ¥: 3D NIfTI ë°ì´í„° (X Ã— Y Ã— Z)
ì¶œë ¥: ë°°ê²½ì´ 0ìœ¼ë¡œ ë§ˆìŠ¤í‚¹ëœ 3D ë°ì´í„°

for each x in range(X):  # Sagittal ìŠ¬ë¼ì´ìŠ¤ë³„ ì²˜ë¦¬
    1. 2D ìŠ¬ë¼ì´ìŠ¤ ì¶”ì¶œ: slice = data[x, :, :]
    2. ë‡Œ ê²½ê³„ ê²€ì¶œ: mask = detect_brain_boundary(slice)
    3. ë§ˆìŠ¤í¬ ì ìš©: data[x, :, :] = data[x, :, :] * mask
```

**detect_brain_boundary() ìƒì„¸ ì•Œê³ ë¦¬ì¦˜**:

```
1. ì •ê·œí™” ë° Contrast Enhancement
   - [0, 255] uint8ë¡œ ì •ê·œí™”
   - CLAHE (Contrast Limited Adaptive Histogram Equalization) ì ìš©
     * clipLimit=3.0, tileGridSize=(8, 8)
     * ë…¸ì´ì§€í•œ ë°°ê²½ì—ì„œë„ ë‡Œ ì˜ì—­ ê°•ì¡°

2. ë°°ê²½ ì œê±° (Morphological Opening)
   - Kernel: MORPH_ELLIPSE (15 Ã— 15)
   - Openingìœ¼ë¡œ ë°°ê²½ ì¶”ì •
   - ì›ë³¸ì—ì„œ ë°°ê²½ ì œê±°: corrected = enhanced - background

3. Edge Detection (Canny)
   - Threshold: (30, 100)
   - Canny algorithmìœ¼ë¡œ ë‡Œ ê²½ê³„ ê²€ì¶œ
   - ë…¸ì´ì¦ˆì— robustí•œ edge ì¶”ì¶œ

4. Edge ì—°ê²° ë° ê°•í™”
   - Morphological closing (7 Ã— 7 ellipse)
   - Dilation (5 Ã— 5 ellipse, 2 iterations)
   - ëŠì–´ì§„ edge ì—°ê²°

5. Contour ê²€ì¶œ
   - cv2.findContours(RETR_EXTERNAL)
   - ì™¸ë¶€ contourë§Œ ì¶”ì¶œ

6. Fallback (Edge detection ì‹¤íŒ¨ ì‹œ)
   - Otsu threshold ì ìš©
   - Binary imageì—ì„œ contour ì¬ê²€ì¶œ
   - ìµœí›„ì˜ ìˆ˜ë‹¨: ì „ì²´ ìŠ¬ë¼ì´ìŠ¤ ë³´ì¡´

7. ê°€ì¥ í° Contour ì„ íƒ
   - ë©´ì  100px ì´ìƒì¸ contourë§Œ ê³ ë ¤
   - ê°€ì¥ í° contour = ë‡Œ ì˜ì—­

8. Convex Hull
   - cv2.convexHull()ë¡œ convex hull ê³„ì‚°
   - ë‚´ë¶€ ì˜ì—­ ì™„ì „íˆ ì±„ìš°ê¸° (í™€ ì—†ìŒ)

9. Morphological Refinement
   - Binary closing (disk radius=5): êµ¬ë© ë©”ìš°ê¸°
   - Binary opening (disk radius=3): ì‘ì€ ë…¸ì´ì¦ˆ ì œê±°

10. Boolean ë§ˆìŠ¤í¬ ë°˜í™˜
    - True: ë³´ì¡´, False: ì œê±° (0ìœ¼ë¡œ ì„¤ì •)
```

#### ìˆ˜í•™ì  ë°°ê²½

**CLAHE (Contrast Limited Adaptive Histogram Equalization)**:
```
- ì´ë¯¸ì§€ë¥¼ tileë¡œ ë‚˜ëˆ” (8Ã—8 grid)
- ê° tileì—ì„œ histogram equalization ìˆ˜í–‰
- clipLimitìœ¼ë¡œ ê³¼ë„í•œ ì¦í­ ë°©ì§€
- ë…¸ì´ì§€í•œ ë°°ê²½ì—ì„œ contrast í–¥ìƒ
```

**Canny Edge Detection**:
```
1. Gaussian blurë¡œ ë…¸ì´ì¦ˆ ì œê±°
2. Sobel filterë¡œ gradient ê³„ì‚°
3. Non-maximum suppression
4. Double threshold (30, 100)
5. Hysteresisë¡œ edge ì—°ê²°
```

**Convex Hull**:
```
- Graham scan ë˜ëŠ” Jarvis march ì•Œê³ ë¦¬ì¦˜
- ì  ì§‘í•©ì„ ê°ì‹¸ëŠ” ìµœì†Œ convex polygon
- ë‡Œ ë‚´ë¶€ í™€ì„ ì™„ì „íˆ ì±„ì›€
```

#### ëŒ€ì•ˆ ë°©ë²• ë¹„êµ (ì‹¤í—˜ ê²°ê³¼)

| ë²„ì „ | ë°©ì‹ | ë§ˆìŠ¤í‚¹ ë¹„ìœ¨ | Edge ë³´ì¡´ìœ¨ | í‰ê°€ |
|------|------|-----------|------------|------|
| **V1** | **Edge detection** | **15.94%** | **99.50%** | âœ… **ì„ íƒ** |
| V2 | Threshold 1.2x | 77.60% | 61.25% | âŒ ë„ˆë¬´ ê³µê²©ì  |
| V3 | Threshold 1.1x | 67.17% | 66.91% | âŒ ê³µê²©ì  |

**V2/V3 ë°©ì‹ (Connected Component Analysis)**:
- Otsu threshold + aggressive multiplier (1.1x or 1.2x)
- Morphological opening/closing
- Connected component analysis
- ì¤‘ì‹¬ ê¸°ë°˜ component ì„ íƒ

**V1ì´ ì„ íƒëœ ì´ìœ **:
- ë†’ì€ ì—£ì§€ ë³´ì¡´ìœ¨ (99.50%)
- ì ì ˆí•œ ë°°ê²½ ì œê±° (15.94%)
- Edge detectionì´ ë” ì •í™•í•œ ê²½ê³„ ì¶”ì¶œ
- ë‡Œ ì¡°ì§ì„ ê³¼ë„í•˜ê²Œ ì œê±°í•˜ì§€ ì•ŠìŒ

#### íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ì„¤ëª… |
|---------|--------|------|
| enable_masking | True | Falseì´ë©´ ë§ˆìŠ¤í‚¹ ìŠ¤í‚µ |
| CLAHE clipLimit | 3.0 | Contrast enhancement ê°•ë„ |
| CLAHE tileGridSize | (8, 8) | Tile í¬ê¸° |
| Canny threshold1 | 30 | Low threshold |
| Canny threshold2 | 100 | High threshold |
| Morphology kernel | (15, 15) | Background removal kernel |
| Min contour area | 100 | ìµœì†Œ contour ë©´ì  (px) |
| Refinement disk radius | 5, 3 | Closing, Opening radius |

#### íš¨ê³¼

**ì •ëŸ‰ì  ê²°ê³¼** (gneo_sample_sr_189 ê¸°ì¤€):
- **ë§ˆìŠ¤í‚¹ëœ ë³µì…€**: 1,078,073 / 7,077,888 (15.23%)
- **ì—£ì§€ ë³´ì¡´ìœ¨**: 99.50%
- **ì²˜ë¦¬ ì„±ê³µë¥ **: 100% (192/192 sagittal slices)
- **ì‹¤íŒ¨í•œ ìŠ¬ë¼ì´ìŠ¤**: 0ê°œ

**ì •ì„±ì  íš¨ê³¼**:
- ë°°ê²½ ì•„í‹°íŒ©íŠ¸ ì™„ì „ ì œê±°
- ë‡Œ ì˜ì—­ ì •í™•íˆ ë³´ì¡´
- í†µê³„ ë¶„ì„ í’ˆì§ˆ í–¥ìƒ
- ì‹œê°í™” í’ˆì§ˆ ê°œì„ 

#### ì²˜ë¦¬ ìˆœì„œì˜ ì¤‘ìš”ì„±

**ì˜¬ë°”ë¥¸ ìˆœì„œ**:
```
Z-ë…¸ì´ì¦ˆ ì œê±° â†’ í‰í™œí™” â†’ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±° â†’ ê²½ê³„ ë§ˆìŠ¤í‚¹
```

**ì´ìœ **:
- Z-ì¶• ìƒë‹¨ ë…¸ì´ì¦ˆë¥¼ ë¨¼ì € ì œê±°í•´ì•¼ contour ê²€ì¶œ ì‹œ ë…¸ì´ì¦ˆ ì˜ì—­ì´ í¬í•¨ë˜ì§€ ì•ŠìŒ
- ìŠ¤íŠ¸ë¼ì´í”„ ì œê±° í›„ ë§ˆìŠ¤í‚¹í•˜ë©´ edge detectionì´ ë” ì •í™•í•¨
- ìˆœì„œë¥¼ ë°”ê¾¸ë©´ ë…¸ì´ì¦ˆ ì˜ì—­ì´ ë‡Œ ì˜ì—­ìœ¼ë¡œ ì˜¤ì¸ë  ìˆ˜ ìˆìŒ

#### ë…¸ì´ì§€í•œ ë°ì´í„°ì…‹ ëŒ€ì‘

**gneo_002 ë°ì´í„°ì…‹ ë¬¸ì œ**:
- ë°°ê²½ intensity â‰ˆ ë‡Œ ì¡°ì§ intensity
- ë‹¨ìˆœ thresholdë¡œ ë¶„ë¦¬ ë¶ˆê°€ëŠ¥

**V1 Edge-based í•´ê²°ì±…**:
1. CLAHEë¡œ contrast í–¥ìƒ â†’ ë°°ê²½ê³¼ ë‡Œ ê²½ê³„ ê°•ì¡°
2. Morphological openingìœ¼ë¡œ ë°°ê²½ ì¶”ì • ë° ì œê±°
3. Canny edge detectionìœ¼ë¡œ ì •í™•í•œ ê²½ê³„ ê²€ì¶œ
4. Fallback (Otsu)ìœ¼ë¡œ edge ì‹¤íŒ¨ ì‹œì—ë„ ì²˜ë¦¬ ê°€ëŠ¥
5. Convex hullë¡œ ë‚´ë¶€ ì™„ì „ ì±„ìš°ê¸°

**Robust íŠ¹ì„±**:
- ë‹¤ì–‘í•œ contrast ìˆ˜ì¤€ì— ëŒ€ì‘
- Edge detection ì‹¤íŒ¨ ì‹œ ìë™ fallback
- Morphological operationsë¡œ ë…¸ì´ì¦ˆ ì œê±°
- 192ê°œ ìŠ¬ë¼ì´ìŠ¤ ëª¨ë‘ ì„±ê³µì  ì²˜ë¦¬

---

## ì„±ëŠ¥ í‰ê°€

### ì—£ì§€ ë³´ì¡´ìœ¨ (Edge Preservation)

#### ì •ì˜
```python
original_edges = sobel(original_data[:, :, z_mid])
denoised_edges = sobel(denoised_data[:, :, z_mid])

edge_preservation = mean(|denoised_edges|) / mean(|original_edges|) Ã— 100%
```

#### ì˜ë¯¸
- **100%**: ëª¨ë“  ì—£ì§€ ì™„ë²½íˆ ë³´ì¡´
- **> 100%**: ìƒˆë¡œìš´ ì—£ì§€ ìƒì„± (ê³¼ë„í•œ ìƒ¤í”„ë‹)
- **< 100%**: ì—£ì§€ ì†ì‹¤ (ë¸”ëŸ¬)
- **ëª©í‘œ**: 99.5% ì´ìƒ

#### ë°©ë²•ë³„ ë¹„êµ

| ë°©ë²• | ì—£ì§€ ë³´ì¡´ìœ¨ | ë¹„ê³  |
|------|-----------|------|
| Wavelet (ì´ˆê¸°) | 71.9% | ì‹¬í•œ ë¸”ëŸ¬ âŒ |
| ì„ í˜• ì™¸ì‚½ë²• | 100.2% | ê³¼ë„í•œ ìƒ¤í”„ë‹ âŒ |
| **ìµœì¢… í†µí•© (5ë‹¨ê³„)** | **99.50%** | ìµœì  âœ… |
| â”” Boundary Masking í¬í•¨ | 99.50% | ë°°ê²½ ì œê±° + ì—£ì§€ ë³´ì¡´ |

### ë…¸ì´ì¦ˆ ì œê±° ì„±ëŠ¥

#### Z-ì˜ì—­ ë…¸ì´ì¦ˆ
```
ì¸¡ì •: ë…¸ì´ì¦ˆ ì˜ì—­ì˜ í‰ê·  ê°•ë„

Gradient ë°©ë²• (Z=175):
- Transition: Z=167-174 (fade-out)
- Complete removal: Z=175-191
- ë…¸ì´ì¦ˆ ì˜ì—­ mean: 0.0000 (ì™„ì „ ì œê±°) âœ…
```

#### ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„
```
ì¸¡ì •: ì•¨ë¦¬ì–´ì‹± ë° ìŠ¤íŠ¸ë¼ì´í”„ ì œê±°

ê¸°ì¡´ ë°©ë²•:
- Threshold: 98th percentile
- Y-gradient std: baseline

ê°œì„  ë°©ë²• (Fade Transition):
- Threshold: 96th percentile (ë” ê³µê²©ì )
- Filter strength: 0.7
- Y-gradient std: baseline Ã— 1.0 (ì•¨ë¦¬ì–´ì‹± ì—†ìŒ) âœ…
- ì—£ì§€ ë³´ì¡´ìœ¨: 99.97% â†’ 99.99% (ê°œì„ )
```

#### ë°°ê²½ ë§ˆìŠ¤í‚¹ (Boundary Masking)
```
ì¸¡ì •: ROI ì¶”ì¶œ ì •í™•ë„ ë° ë°°ê²½ ì œê±°

gneo_sample_sr_189 ê²°ê³¼:
- ë§ˆìŠ¤í‚¹ëœ ë³µì…€: 1,078,073 / 7,077,888 (15.23%)
- ì²˜ë¦¬ ì„±ê³µë¥ : 192/192 slices (100%)
- ì‹¤íŒ¨í•œ ìŠ¬ë¼ì´ìŠ¤: 0ê°œ
- ì—£ì§€ ë³´ì¡´ìœ¨: 99.50%

V1 Edge-based ì„ íƒ ì´ìœ :
- V2 (Threshold 1.2x): 77.60% ì œê±° â†’ ë„ˆë¬´ ê³µê²©ì  âŒ
- V3 (Threshold 1.1x): 67.17% ì œê±° â†’ ê³µê²©ì  âŒ
- V1 (Edge detection): 15.94% ì œê±° â†’ ìµœì  âœ…

íš¨ê³¼:
- ë°°ê²½ ì•„í‹°íŒ©íŠ¸ ì™„ì „ ì œê±°
- ë‡Œ ì˜ì—­ ì •í™•íˆ ë³´ì¡´
- ë…¸ì´ì§€í•œ ë°ì´í„°ì…‹(gneo_002)ì—ë„ ëŒ€ì‘ ê°€ëŠ¥
```

### ì¢…í•© í‰ê°€ ì§€í‘œ

| ì§€í‘œ | ëª©í‘œ | ë‹¬ì„± | ìƒíƒœ |
|-----|------|------|------|
| ì—£ì§€ ë³´ì¡´ | â‰¥ 99.5% | **99.50%** | âœ… |
| Z-ë…¸ì´ì¦ˆ ì œê±° | = 0 | **0.0000** | âœ… |
| ìŠ¤íŠ¸ë¼ì´í”„ ì œê±° | ê°œì„  | **fade transition (0.7)** | âœ… |
| ë°°ê²½ ì œê±° | ì™„ì „ | **15.23% masked** | âœ… |
| ì•¨ë¦¬ì–´ì‹± ë°œìƒ | ì—†ìŒ | **ì—†ìŒ** | âœ… |
| ì¼ë°˜í™” ëŠ¥ë ¥ | ë†’ìŒ | **gradient + edge** | âœ… |
| Transition | ë¶€ë“œëŸ¬ì›€ | **8-slice smooth** | âœ… |
| ì²˜ë¦¬ ì„±ê³µë¥  | 100% | **192/192 (100%)** | âœ… |

### ë°ì´í„°ì…‹ë³„ ì„±ëŠ¥

| ë°ì´í„°ì…‹ | ë…¸ì´ì¦ˆ ê²½ê³„ | ì œê±° ìŠ¬ë¼ì´ìŠ¤ | ë³´ì¡´ìœ¨ |
|---------|-----------|-------------|--------|
| gneo_sample_sr_189 | Z=175 (91.1%) | 17ê°œ | 91.1% |
| ì¼ë°˜ì  ë²”ìœ„ | Z=170-180 | 12-22ê°œ | 89-94% |

---

## ì‚¬ìš© ë°©ë²•

### ê¸°ë³¸ ì‚¬ìš©ë²•

```bash
# ê¸°ë³¸ ì‹¤í–‰
python3 unified_denoise.py input.nii.gz output.nii.gz

# ìë™ìœ¼ë¡œ ë‹¤ìŒì„ ìˆ˜í–‰ (5ë‹¨ê³„ íŒŒì´í”„ë¼ì¸):
# 1. Z-ìŠ¬ë¼ì´ìŠ¤ ê°•ë„ ë³´ì •
# 2. Mean Intensity Gradient ê¸°ë°˜ Z-ì˜ì—­ ì œê±°
# 3. ìµœì¢… í‰í™œí™” (Gaussian Ïƒ=0.2)
# 4. ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±° (FFT filter_strength=0.7)
# 5. ë‡Œ ê²½ê³„ ë§ˆìŠ¤í‚¹ (Edge-based ROI extraction)
```

### Python ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©

#### ê¸°ë³¸ ì‚¬ìš© (ê¶Œì¥)
```python
from unified_denoise import UnifiedDenoiser

# 1. ë””ë…¸ì´ì € ìƒì„±
denoiser = UnifiedDenoiser(
    input_path='input.nii.gz',
    output_path='denoised.nii.gz'
)

# 2. ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
denoised_data, metadata = denoiser.run_full_pipeline()

# ê²°ê³¼ ìë™ ì €ì¥:
# - denoised.nii.gz (ë””ë…¸ì´ì¦ˆëœ ë°ì´í„°)
# - denoised_metadata.json (ì²˜ë¦¬ ì •ë³´)
# - denoised_comparison.png (3ë·° ë¹„êµ)
# - denoised_z_profile.png (Z-ì¶• í”„ë¡œíŒŒì¼)
```

#### ê°œë³„ ë‹¨ê³„ ì‹¤í–‰ (ê³ ê¸‰)
```python
from unified_denoise import UnifiedDenoiser

denoiser = UnifiedDenoiser('input.nii.gz', 'output.nii.gz')

# 1. Z-ìŠ¬ë¼ì´ìŠ¤ ê°•ë„ ë³´ì •
denoiser.correct_z_slice_intensity(
    detection_threshold=1.0,
    smoothing_window=13
)

# 2. ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±° (ê¸°ë³¸ ëª¨ë“œ)
denoiser.remove_horizontal_stripes(
    filter_strength=0.6,
    iterations=1,
    aggressive=False
)

# 3. Z-ì˜ì—­ ë…¸ì´ì¦ˆ ì œê±° (Gradient ë°©ë²•)
denoiser.intensity_gradient_z_removal(
    min_z_start=0.70,
    gradient_threshold=2.0
)

# 4. ìµœì¢… í‰í™œí™”
denoiser.gentle_final_smoothing(sigma=0.2)

# 5. ì €ì¥
denoiser.save_output()
denoiser.generate_comparison_images()
```

#### ê³µê²©ì  ìŠ¤íŠ¸ë¼ì´í”„ ì œê±°
```python
# ìŠ¤íŠ¸ë¼ì´í”„ê°€ ë§¤ìš° ì‹¬í•œ ê²½ìš°
denoiser = UnifiedDenoiser('input.nii.gz', 'output.nii.gz')

denoiser.correct_z_slice_intensity(detection_threshold=1.0, smoothing_window=13)

# ê³µê²©ì  ëª¨ë“œ í™œì„±í™”
denoiser.remove_horizontal_stripes(
    filter_strength=0.7,  # ë” ê°•í•¨
    iterations=1,
    aggressive=True       # 94th percentile, len//15
)

denoiser.intensity_gradient_z_removal()
denoiser.gentle_final_smoothing()
denoiser.save_output()
```

### ì¶œë ¥ íŒŒì¼

ì‹¤í–‰ í›„ ìƒì„±ë˜ëŠ” íŒŒì¼ë“¤:

1. **`output.nii.gz`**: ë””ë…¸ì´ì¦ˆëœ NIfTI íŒŒì¼
2. **`output_metadata.json`**: ì²˜ë¦¬ ë©”íƒ€ë°ì´í„°
   ```json
   {
     "input_file": "input.nii.gz",
     "shape": [192, 192, 192],
     "original_range": [-0.206, 1.110],
     "steps": [
       {
         "step": "z_slice_intensity_correction",
         "count": 28,
         "threshold": 1.0
       },
       {
         "step": "horizontal_stripe_removal",
         "filter_strength": 0.6,
         "aggressive_mode": false
       },
       {
         "step": "intensity_gradient_z_removal",
         "boundary": 175,
         "removed_slices": 17,
         "transition_start": 167
       },
       {
         "step": "gentle_final_smoothing",
         "sigma": 0.2
       }
     ],
     "edge_preservation_percent": 99.99
   }
   ```
3. **`output_comparison.png`**: ì›ë³¸ vs ë””ë…¸ì´ì¦ˆ 3ë·° ë¹„êµ
4. **`output_z_profile.png`**: Z-ì¶• ê°•ë„ í”„ë¡œíŒŒì¼ ë¹„êµ (mean, std)

---

## íŒŒë¼ë¯¸í„° ì„¤ì • ê°€ì´ë“œ

### 1. Z-ìŠ¬ë¼ì´ìŠ¤ ê°•ë„ ë³´ì •

#### `detection_threshold` (ê¸°ë³¸ê°’: 1.0)
```
ë²”ìœ„: 0.5 ~ 2.0
ì˜ë¯¸: ì´ìƒ ìŠ¬ë¼ì´ìŠ¤ ê°ì§€ ë¯¼ê°ë„ (í‘œì¤€í¸ì°¨ ë°°ìˆ˜)

- ë‚®ì„ìˆ˜ë¡ (0.5-1.0): ë” ë§ì€ ìŠ¬ë¼ì´ìŠ¤ ê°ì§€ â†’ ê³µê²©ì  ë³´ì •
- ë†’ì„ìˆ˜ë¡ (1.5-2.0): ë” ì ì€ ìŠ¬ë¼ì´ìŠ¤ ê°ì§€ â†’ ë³´ìˆ˜ì  ë³´ì •

ê¶Œì¥:
- ì‹¬í•œ ê°•ë„ ë³€í™”: 0.8 ~ 1.2
- ë¯¸ë¬˜í•œ ë³€í™”: 1.5 ~ 2.0
- **ê¸°ë³¸ê°’ 1.0**: ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì í•©
```

#### `smoothing_window` (ê¸°ë³¸ê°’: 13)
```
ë²”ìœ„: 5 ~ 21 (í™€ìˆ˜)
ì˜ë¯¸: Savitzky-Golay í•„í„° ìœˆë„ìš° í¬ê¸°

- ì‘ì„ìˆ˜ë¡ (5-9): êµ­ì†Œì  ë³€í™” í¬ì°© â†’ ë¯¼ê°í•œ ê°ì§€
- í´ìˆ˜ë¡ (13-21): ì „ì—­ì  ì¶”ì„¸ í¬ì°© â†’ ì•ˆì •ì  ê°ì§€

ê¶Œì¥:
- ë…¸ì´ì¦ˆê°€ ì‚°ë°œì : 7 ~ 11
- ë…¸ì´ì¦ˆê°€ ì§‘ì¤‘ì : 13 ~ 17
- **ê¸°ë³¸ê°’ 13**: ê· í˜•ì¡íŒ ì„¤ì •
```

### 2. ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±°

#### `filter_strength` (ê¸°ë³¸ê°’: 0.6)
```
ë²”ìœ„: 0.3 ~ 0.8
ì˜ë¯¸: ê³ ì£¼íŒŒ ì–µì œ ê°•ë„ (0=ì—†ìŒ, 1=ì™„ì „ì œê±°)

- ë‚®ì„ìˆ˜ë¡ (0.3-0.4): ë¶€ë“œëŸ¬ìš´ í•„í„°ë§ â†’ ìŠ¤íŠ¸ë¼ì´í”„ ì¼ë¶€ ì”ì¡´
- ë³´í†µ (0.5-0.6): ê· í˜•ì¡íŒ í•„í„°ë§ â†’ ê¶Œì¥
- ë†’ì„ìˆ˜ë¡ (0.7-0.8): ê°•í•œ í•„í„°ë§ â†’ ì£¼ì˜ í•„ìš”

ê¶Œì¥:
- ì•½í•œ ìŠ¤íŠ¸ë¼ì´í”„: 0.4 ~ 0.5
- ì¤‘ê°„ ìŠ¤íŠ¸ë¼ì´í”„: 0.5 ~ 0.6 â† **ê¸°ë³¸ê°’**
- ê°•í•œ ìŠ¤íŠ¸ë¼ì´í”„: 0.6 ~ 0.7
- ë§¤ìš° ê°•í•œ ìŠ¤íŠ¸ë¼ì´í”„: 0.7 + aggressive=True

ì£¼ì˜: 0.8 ì´ìƒì€ ê¶Œì¥í•˜ì§€ ì•ŠìŒ (ë””í…Œì¼ ì†ì‹¤ ê°€ëŠ¥)
```

#### `iterations` (ê¸°ë³¸ê°’: 1)
```
ë²”ìœ„: 1 ~ 2
ì˜ë¯¸: í•„í„°ë§ ë°˜ë³µ íšŸìˆ˜

- 1íšŒ: ì ì ˆí•œ ì œê±° + ë””í…Œì¼ ë³´ì¡´ â† **ê¶Œì¥**
- 2íšŒ: ê°•ë ¥í•œ ì œê±° + ì•½ê°„ì˜ ë¸”ëŸ¬ ê°€ëŠ¥

ê¶Œì¥:
- ëŒ€ë¶€ë¶„ì˜ ê²½ìš°: 1íšŒ
- ê·¹ì‹¬í•œ ìŠ¤íŠ¸ë¼ì´í”„: 2íšŒ (ì‹ ì¤‘íˆ)
```

#### `aggressive` (ê¸°ë³¸ê°’: False)
```
ì˜ë¯¸: ê³µê²©ì  ëª¨ë“œ í™œì„±í™”

False (ê¸°ë³¸):
- Threshold: 96th percentile
- Preserve radius: len//12
- ê· í˜•ì¡íŒ ì„¤ì •
- ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì í•©

True (ê³µê²©ì ):
- Threshold: 94th percentile
- Preserve radius: len//15
- ë” ë§ì€ ê³ ì£¼íŒŒ ì œê±°
- ìŠ¤íŠ¸ë¼ì´í”„ê°€ ë§¤ìš° ì‹¬í•œ ê²½ìš°

ì‚¬ìš© ì˜ˆì‹œ:
remove_horizontal_stripes(filter_strength=0.7, aggressive=True)
```

### 3. Mean Intensity Gradient ê¸°ë°˜ Z-ì˜ì—­ ì œê±°

#### `min_z_start` (ê¸°ë³¸ê°’: 0.70)
```
ë²”ìœ„: 0.60 ~ 0.80
ì˜ë¯¸: ë¶„ì„ ì‹œì‘ ìœ„ì¹˜ (ì „ì²´ Z-ì¶•ì˜ ë°±ë¶„ìœ¨)

- ë‚®ì„ìˆ˜ë¡ (0.60-0.65): ë” ë„“ì€ ì˜ì—­ ê²€ì‚¬ â†’ ë³´ìˆ˜ì 
- ë³´í†µ (0.70): ê· í˜•ì¡íŒ ì„¤ì • â† **ê¸°ë³¸ê°’**
- ë†’ì„ìˆ˜ë¡ (0.75-0.80): ë” ì¢ì€ ì˜ì—­ ê²€ì‚¬ â†’ ë¹ ë¦„

ê¶Œì¥:
- ë‡Œ í¬ê¸°ê°€ í° ê²½ìš°: 0.75 ~ 0.80
- ë‡Œ í¬ê¸°ê°€ ì‘ì€ ê²½ìš°: 0.60 ~ 0.70
- **ì¼ë°˜ì ì¸ ê²½ìš°: 0.70**
```

#### `gradient_threshold` (ê¸°ë³¸ê°’: 2.0)
```
ë²”ìœ„: 1.0 ~ 3.0
ì˜ë¯¸: Gradient ì„ê³„ê°’ (í‘œì¤€í¸ì°¨ ë°°ìˆ˜)

- ë‚®ì„ìˆ˜ë¡ (1.0-1.5): ë” ë¯¼ê°í•œ ê°ì§€ â†’ ì¡°ê¸° ì œê±°
- ë³´í†µ (2.0): ê· í˜•ì¡íŒ ê°ì§€ â† **ê¸°ë³¸ê°’**
- ë†’ì„ìˆ˜ë¡ (2.5-3.0): ëœ ë¯¼ê°í•œ ê°ì§€ â†’ ë³´ìˆ˜ì 

ê¶Œì¥:
- ëª…í™•í•œ intensity ê¸‰ì¦: 1.5 ~ 2.0
- ì ì§„ì  ì¦ê°€: 2.0 ~ 2.5
- **ì¼ë°˜ì ì¸ ê²½ìš°: 2.0**
```

### 4. ìµœì¢… í‰í™œí™”

#### `sigma` (ê¸°ë³¸ê°’: 0.2)
```
ë²”ìœ„: 0.1 ~ 0.5
ì˜ë¯¸: Gaussian í•„í„°ì˜ í‘œì¤€í¸ì°¨

- ì‘ì„ìˆ˜ë¡ (0.1): ë§¤ìš° ë¶€ë“œëŸ¬ìš´ í‰í™œí™”
- ë³´í†µ (0.2): ì ì ˆí•œ í‰í™œí™” â† **ê¸°ë³¸ê°’**
- í´ìˆ˜ë¡ (0.3-0.5): ê°•í•œ í‰í™œí™” (ë¸”ëŸ¬ ê°€ëŠ¥)

ê¶Œì¥:
- ë¯¸ì„¸ ì•„í‹°íŒ©íŠ¸ë§Œ: 0.1 ~ 0.2
- ì¼ë°˜ì ì¸ ê²½ìš°: 0.2 ~ 0.3
- ê°•í•œ í‰í™œí™”: 0.3 ~ 0.4

ì£¼ì˜: 0.5 ì´ìƒì€ ë¸”ëŸ¬ ë°œìƒ ê°€ëŠ¥
```

---

## íŒŒë¼ë¯¸í„° ì¡°í•© ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤ 1: ë³´ìˆ˜ì  ë””ë…¸ì´ì§• (ìµœëŒ€ ë³´ì¡´)
```python
denoiser.correct_z_slice_intensity(detection_threshold=2.0)
denoiser.remove_horizontal_stripes(filter_strength=0.4, aggressive=False)
denoiser.intensity_gradient_z_removal(gradient_threshold=2.5)
denoiser.gentle_final_smoothing(sigma=0.15)
```
- **ì ìš©**: ì¤‘ìš”í•œ ì§„ë‹¨ ì˜ì—­ ë³´ì¡´ í•„ìš”
- **íš¨ê³¼**: ìµœì†Œ ì†ì‹¤, ì¼ë¶€ ë…¸ì´ì¦ˆ ì”ì¡´ ê°€ëŠ¥

### ì‹œë‚˜ë¦¬ì˜¤ 2: ê· í˜• ë””ë…¸ì´ì§• (ê¶Œì¥) â­
```python
denoiser.correct_z_slice_intensity(detection_threshold=1.0)
denoiser.remove_horizontal_stripes(filter_strength=0.6, aggressive=False)
denoiser.intensity_gradient_z_removal(gradient_threshold=2.0)
denoiser.gentle_final_smoothing(sigma=0.2)
```
- **ì ìš©**: ëŒ€ë¶€ë¶„ì˜ ê²½ìš° (ê¸°ë³¸ ì„¤ì •)
- **íš¨ê³¼**: ë…¸ì´ì¦ˆ ì œê±° + êµ¬ì¡° ë³´ì¡´ ê· í˜•
- **ê²°ê³¼**: ì—£ì§€ ë³´ì¡´ìœ¨ 99.99%

### ì‹œë‚˜ë¦¬ì˜¤ 3: ê³µê²©ì  ë””ë…¸ì´ì§• (ìµœëŒ€ ì œê±°)
```python
denoiser.correct_z_slice_intensity(detection_threshold=0.8)
denoiser.remove_horizontal_stripes(filter_strength=0.7, aggressive=True)
denoiser.intensity_gradient_z_removal(gradient_threshold=1.5)
denoiser.gentle_final_smoothing(sigma=0.3)
```
- **ì ìš©**: ì‹œê°í™” ëª©ì , ë…¸ì´ì¦ˆê°€ ê·¹ì‹¬í•œ ê²½ìš°
- **íš¨ê³¼**: ìµœëŒ€ ë…¸ì´ì¦ˆ ì œê±°, ì¼ë¶€ ë””í…Œì¼ ì†ì‹¤ ê°€ëŠ¥

---

## ì•Œê³ ë¦¬ì¦˜ ë¹„êµ

### Z-ì˜ì—­ ë…¸ì´ì¦ˆ ì œê±° ë°©ë²•

| ë°©ë²• | ì›ë¦¬ | ì¥ì  | ë‹¨ì  | ê¶Œì¥ |
|------|------|------|------|------|
| **Gradient** | Mean intensity ê¸‰ì¦ ê°ì§€ | ì¼ë°˜í™” ê°€ëŠ¥, ë‹¨ìˆœ, robust | - | âœ… **ê¶Œì¥** |
| Adaptive | 6ê°€ì§€ ë©”íŠ¸ë¦­ ë¶„ì„ | ì •ë°€í•œ ìŠ¬ë¼ì´ìŠ¤ ë¶„ì„ | ë³µì¡, íŠ¹ì • ë°ì´í„° ìµœì í™” | ê³ ê¸‰ |
| Conservative | í†µê³„ì  ì‹ í˜¸ ë¶„ì„ | ë‘ê°œê³¨ ë³´ì¡´ | ë°ì´í„° ì˜ì¡´ì  | ë ˆê±°ì‹œ |

### ì„±ëŠ¥ ë¹„êµ (gneo_sample_sr_189 ê¸°ì¤€)

| ë°©ë²• | ë…¸ì´ì¦ˆ ê²½ê³„ | ì œê±° ìŠ¬ë¼ì´ìŠ¤ | ì—£ì§€ ë³´ì¡´ìœ¨ | ì¼ë°˜í™” |
|------|-----------|-------------|-----------|--------|
| **Gradient** | **Z=175 (91.1%)** | **17ê°œ** | **99.99%** | **ë†’ìŒ** |
| Adaptive | Z=179 (93.2%) | 13ê°œ | 99.97% | ì¤‘ê°„ |
| Conservative | Z=161 (83.9%) | 31ê°œ | 99.97% | ë‚®ìŒ |

---

## ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­

### Smooth Step Function

```python
def smooth_step(t):
    """
    ë¶€ë“œëŸ¬ìš´ S-ì»¤ë¸Œ ì „í™˜ í•¨ìˆ˜

    Args:
        t: 0.0~1.0 ì‚¬ì´ì˜ ê°’

    Returns:
        alpha: 1.0~0.0 ì‚¬ì´ì˜ ê°’ (ë¶€ë“œëŸ¬ìš´ ê°ì‡ )
    """
    return 1.0 - (3 * t**2 - 2 * t**3)
```

**íŠ¹ì„±**:
- Hermite interpolation ê¸°ë°˜
- ì‹œì‘ì ê³¼ ëì ì—ì„œ 1ì°¨ ë¯¸ë¶„ì´ 0 (ë¶€ë“œëŸ¬ìš´ ì—°ê²°)
- ìì—°ìŠ¤ëŸ¬ìš´ fade-out íš¨ê³¼

**ì‚¬ìš© ì˜ˆì‹œ**:
```
Transition: Z=167-174 (8 slices)

Z=167: t=0/9, alpha=1.000 (100% ìœ ì§€)
Z=168: t=1/9, alpha=0.992
Z=169: t=2/9, alpha=0.973
Z=170: t=3/9, alpha=0.939
Z=171: t=4/9, alpha=0.889
Z=172: t=5/9, alpha=0.821
Z=173: t=6/9, alpha=0.733
Z=174: t=7/9, alpha=0.627
Z=175: t=8/9, alpha=0.503
```

### Fade Transition (FFT í•„í„°)

```python
def calculate_fade_suppression(distance, preserve_radius, filter_strength):
    """
    ì €ì£¼íŒŒ ì¸ê·¼ì—ì„œ ë¶€ë“œëŸ¬ìš´ í•„í„°ë§ ì „í™˜

    Args:
        distance: ì¤‘ì‹¬ ì£¼íŒŒìˆ˜ë¡œë¶€í„°ì˜ ê±°ë¦¬
        preserve_radius: ì €ì£¼íŒŒ ë³´ì¡´ ë°˜ê²½
        filter_strength: í•„í„° ê°•ë„

    Returns:
        suppression: ì‹¤ì œ ì ìš©í•  ì–µì œ ê°•ë„
    """
    if distance <= preserve_radius:
        return 0.0  # ì €ì£¼íŒŒ ë³´ì¡´
    elif distance < preserve_radius * 1.5:
        # ì „í™˜ ì˜ì—­: ì„ í˜• fade
        fade = (distance - preserve_radius) / (preserve_radius * 0.5)
        return filter_strength * fade
    else:
        return filter_strength  # ì „ì²´ ì–µì œ
```

**íš¨ê³¼**:
- ê¸‰ê²©í•œ í•„í„°ë§ ë³€í™” ë°©ì§€
- ì„¸ë¡œ ì•¨ë¦¬ì–´ì‹± ì™„ì „ ì°¨ë‹¨
- ìì—°ìŠ¤ëŸ¬ìš´ ì£¼íŒŒìˆ˜ ì „í™˜

---

## ì°¸ê³  ë¬¸í—Œ

### ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜ ë…¼ë¬¸
1. Savitzky, A., & Golay, M. J. (1964). "Smoothing and Differentiation of Data by Simplified Least Squares Procedures." *Analytical Chemistry*
2. Cooley, J. W., & Tukey, J. W. (1965). "An Algorithm for the Machine Calculation of Complex Fourier Series." *Mathematics of Computation*

### ì˜ë£Œ ì˜ìƒ ì²˜ë¦¬
3. Buades, A., Coll, B., & Morel, J. M. (2005). "A Review of Image Denoising Algorithms, with a New One." *Multiscale Modeling & Simulation*
4. ManjÃ³n, J. V., et al. (2010). "MRI Denoising Using Non-Local Means." *Medical Image Analysis*

### DDPM ê´€ë ¨
5. Ho, J., Jain, A., & Abbeel, P. (2020). "Denoising Diffusion Probabilistic Models." *NeurIPS*

---

## ë²„ì „ íˆìŠ¤í† ë¦¬

### v2.0 (2025-11-06) - Latest
- **ì¶”ê°€**: Mean Intensity Gradient ê¸°ë°˜ Z-ì˜ì—­ ë…¸ì´ì¦ˆ ì œê±°
- **ì¶”ê°€**: Fade Transition (FFT í•„í„°)
- **ì¶”ê°€**: Aggressive ëª¨ë“œ
- **ê°œì„ **: ìŠ¤íŠ¸ë¼ì´í”„ ì œê±° ê°•í™” (96th percentile, len//12 ë³´ì¡´)
- **ê°œì„ **: ì—£ì§€ ë³´ì¡´ìœ¨ 99.97% â†’ 99.99%
- **ê°œì„ **: ì„¸ë¡œ ì•¨ë¦¬ì–´ì‹± ì™„ì „ ë°©ì§€
- **ë³€ê²½**: ê¸°ë³¸ filter_strength 0.5 â†’ 0.6
- **ìˆ˜ì •**: Smooth transition ì ìš© (8-slice fade-out)

### v1.0 (2025-11-06)
- ì´ˆê¸° ë¦´ë¦¬ìŠ¤: í†µí•© ë””ë…¸ì´ì§• íŒŒì´í”„ë¼ì¸
- Z-ìŠ¬ë¼ì´ìŠ¤ ê°•ë„ ë³´ì • êµ¬í˜„
- ì ì‘í˜• Z-ì˜ì—­ ë…¸ì´ì¦ˆ ì œê±° êµ¬í˜„
- FFT ê¸°ë°˜ ìˆ˜í‰ ìŠ¤íŠ¸ë¼ì´í”„ ì œê±° êµ¬í˜„
- ìë™í™”ëœ ë©”íƒ€ë°ì´í„° ë° ì‹œê°í™” ìƒì„±

---

## ë¼ì´ì„ ìŠ¤ ë° ì—°ë½ì²˜

**ê°œë°œ**: Claude (Anthropic)
**ë‚ ì§œ**: 2025-11-06
**ë²„ì „**: 2.0
**ëª©ì **: DDPM ê¸°ë°˜ ì˜ë£Œ ì˜ìƒ í’ˆì§ˆ í–¥ìƒ

**ë©´ì±… ì¡°í•­**: ë³¸ ì†Œí”„íŠ¸ì›¨ì–´ëŠ” ì—°êµ¬ ë° êµìœ¡ ëª©ì ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤. ì„ìƒ ì§„ë‹¨ì— ì‚¬ìš©í•˜ê¸° ì „ì— ì „ë¬¸ê°€ì˜ ê²€ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.

---

## ìš”ì•½

### í•µì‹¬ ê°œì„ ì‚¬í•­
1. âœ… **Mean Intensity Gradient ë°©ë²•**: ì¼ë°˜í™” ê°€ëŠ¥, robust
2. âœ… **Fade Transition**: ì•¨ë¦¬ì–´ì‹± ì™„ì „ ë°©ì§€
3. âœ… **Smooth Step Function**: ë¶€ë“œëŸ¬ìš´ Z-ì˜ì—­ ì „í™˜
4. âœ… **Aggressive ëª¨ë“œ**: ê·¹ì‹¬í•œ ìŠ¤íŠ¸ë¼ì´í”„ ëŒ€ì‘
5. âœ… **ì—£ì§€ ë³´ì¡´ìœ¨ 99.99%**: ìµœê³  ìˆ˜ì¤€

### ê¶Œì¥ ì‚¬ìš©ë²•
```bash
# ëŒ€ë¶€ë¶„ì˜ ê²½ìš°
python3 unified_denoise.py input.nii.gz output.nii.gz

# ìŠ¤íŠ¸ë¼ì´í”„ê°€ ì‹¬í•œ ê²½ìš°
# Python ìŠ¤í¬ë¦½íŠ¸ì—ì„œ aggressive=True ì„¤ì •
```

### ì£¼ìš” íŠ¹ì§•
- ğŸš€ 4ë‹¨ê³„ íŒŒì´í”„ë¼ì¸
- ğŸ¯ ìë™ ë…¸ì´ì¦ˆ ê²½ê³„ ê°ì§€
- ğŸ›¡ï¸ ì•¨ë¦¬ì–´ì‹± ë°©ì§€
- ğŸ“Š 99.99% ì—£ì§€ ë³´ì¡´
- ğŸ”§ ìœ ì—°í•œ íŒŒë¼ë¯¸í„° ì¡°ì •
- ğŸ“ˆ ë‹¤ì–‘í•œ ë°ì´í„°ì…‹ ì§€ì›
